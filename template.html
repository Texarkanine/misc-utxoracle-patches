<!DOCTYPE html>

<html>
<head>
<title>UTXOracle Local</title>
<style>
    body {{
        background-color: black;
        margin: 0;
        color: #CCCCCC;
        font-family: Arial, sans-serif;
        text-align: center;
    }}
    canvas {{
        background-color: black;
        display: block;
        margin: auto;
    }}
    
    
</style>
</head>
<body>



<div id="tooltip" style="
    position: absolute;
    background-color: black;
    color: cyan;
    border: 1px solid cyan;
    padding: 8px;
    font-size: 14px;
    border-radius: 5px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    text-align: left;
    z-index: 10;
"></div>

<div style="position: relative; width: 95%; max-width: 1000px; margin: auto;">
    
    <canvas id="myCanvas" style="width: 100%; height: auto;" width="{width}" height="{height}"></canvas>
    
    <button id="downloadBtn" style="
        position: absolute;
        bottom: 5%;
        right: 2%;
        font-size: 14px;
        padding: 6px 10px;
        background-color: black;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        opacity: 0.85;
    ">
    Save PNG
    </button>

</div>



<script>
const canvas = document.getElementById('myCanvas');
const ctx = canvas.getContext('2d');

const width = {width};
const height = {height};

const marginLeft = {margin_left};
const marginRight = {margin_right};
const marginTop = {margin_top};
const marginBottom = {margin_bottom};

const plotWidth = width - marginLeft - marginRight;
const plotHeight = height - marginTop - marginBottom;

// Data
const heights_smooth = {list(heights_smooth)};
const prices = {list(prices)};
const heights = {list(heights)};
const timestamps = {list(timestamps)};


const ymin = Math.min(...prices);
const ymax = Math.max(...prices);
const xmin = Math.min(...heights_smooth);
const xmax = Math.max(...heights_smooth);

// xticks
const xtick_positions = {xtick_positions};
const xtick_labels = {xtick_labels};


// Scaling functions
function scaleX(t) {{
    return marginLeft + (t - xmin) / (xmax - xmin) * plotWidth;
}}

function scaleY(p) {{
    return marginTop + (1 - (p - ymin) / (ymax - ymin)) * plotHeight;
}}

// Background
ctx.fillStyle = "black";
ctx.fillRect(0, 0, width, height);


// UTXOracle Local Title
ctx.font = "bold 36px Arial";
ctx.textAlign = "center";
ctx.fillStyle = "cyan";
ctx.fillText("UTXOracle", width / 2 - 60, 40);  // Slight left shift for spacing

ctx.fillStyle = "lime";
ctx.fillText("Local", width / 2 + 95, 40);  // Slight right shift

// Plot Date and Consensus Price
ctx.font = "24px Arial";
ctx.textAlign = "right";
ctx.fillStyle = "white";
ctx.fillText("{plot_title_left}", width /2, 80);
ctx.textAlign = "left";
ctx.fillStyle = "lime";
ctx.fillText("{plot_title_right}", width/2 +10, 80);





// Draw axes
ctx.strokeStyle = "white";
ctx.lineWidth = 1;

// Y axis
ctx.beginPath();
ctx.moveTo(marginLeft, marginTop);
ctx.lineTo(marginLeft, marginTop + plotHeight);
ctx.stroke();

// X axis
ctx.beginPath();
ctx.moveTo(marginLeft, marginTop + plotHeight);
ctx.lineTo(marginLeft + plotWidth, marginTop + plotHeight);
ctx.stroke();

// Right spine
ctx.beginPath();
ctx.moveTo(marginLeft + plotWidth, marginTop);
ctx.lineTo(marginLeft + plotWidth, marginTop + plotHeight);
ctx.stroke();

// Top spine
ctx.beginPath();
ctx.moveTo(marginLeft, marginTop);
ctx.lineTo(marginLeft + plotWidth, marginTop);
ctx.stroke();


// Draw ticks and labels
ctx.fillStyle = "white";
ctx.font = "20px Arial";

// Y axis ticks
const yticks = 5;
for (let i = 0; i <= yticks; i++) {{
    let p = ymin + (ymax - ymin) * i / yticks;
    let y = scaleY(p);
    ctx.beginPath();
    ctx.moveTo(marginLeft - 5, y);
    ctx.lineTo(marginLeft, y);
    ctx.stroke();
    ctx.textAlign = "right";
    ctx.fillText(Math.round(p).toLocaleString(), marginLeft - 10, y + 4);
}}

// X axis ticks
ctx.textAlign = "center";
ctx.font = "16px Arial";

for (let i = 0; i < xtick_positions.length; i++) {{
    let x = scaleX(xtick_positions[i]);
    ctx.beginPath();
    ctx.moveTo(x, marginTop + plotHeight);
    ctx.lineTo(x, marginTop + plotHeight + 5);
    ctx.stroke();

    // Split label into two lines
    let parts = xtick_labels[i].split("\\n");
    ctx.fillText(parts[0], x, marginTop + plotHeight + 20);   // Block height
    ctx.fillText(parts[1], x, marginTop + plotHeight + 40);   // Time
}}


// Axis labels
ctx.fillStyle = "white";
ctx.font = "20px Arial";
ctx.textAlign = "center";
ctx.fillText("Block Height and UTC Time", marginLeft + plotWidth/2, height - 48);
ctx.save();
ctx.translate(20, marginTop + plotHeight/2);
ctx.rotate(-Math.PI / 2);
ctx.fillText("BTC Price ($)", 0, 0);
ctx.restore();

// Plot points
ctx.fillStyle = "cyan";
for (let i = 0; i < heights_smooth.length; i++) {{
    let x = scaleX(heights_smooth[i]);
    let y = scaleY(prices[i]);
    ctx.fillRect(x, y, .75, .75);
}}

// Annotation for average price
ctx.fillStyle = "cyan";
ctx.font = "20px Arial";
ctx.textAlign = "left";
ctx.fillText("- {int(avg_price):,}", marginLeft + plotWidth + 1, scaleY({avg_price}) +0);


// Annotate bottom chart note

ctx.font = "24px Arial";
ctx.fillStyle = "lime";
ctx.textAlign = "right";
ctx.fillText("{bottom_note1}", 320, height-10);
ctx.font = "24px Arial";
ctx.fillStyle = "white";
ctx.textAlign = "left";
ctx.fillText("{bottom_note2}", 325, height-10);


// === MOUSEOVER INFO ===

const tooltip = document.getElementById('tooltip');

canvas.addEventListener('mousemove', function(event) {{
const rect = canvas.getBoundingClientRect();
const scaleX = canvas.width / rect.width;
const scaleY = canvas.height / rect.height;
const mouseX = (event.clientX - rect.left) * scaleX;
const mouseY = (event.clientY - rect.top) * scaleY;

if (mouseX >= marginLeft && mouseX <= width - marginRight &&
    mouseY >= marginTop && mouseY <= marginTop + plotHeight) {{

    const fractionAcross = (mouseX - marginLeft) / plotWidth;
    let index = Math.round(fractionAcross * (heights.length - 1));
    index = Math.max(0, Math.min(index, heights.length - 1));

    const price = ymax - (mouseY - marginTop) / plotHeight * (ymax - ymin);
    const blockHeight = heights[index];
    const timestamp = timestamps[index];

    const date = new Date(timestamp * 1000);
    const hours = date.getUTCHours().toString().padStart(2, '0');
    const minutes = date.getUTCMinutes().toString().padStart(2, '0');
    const utcTime = `${{hours}}:${{minutes}} UTC`;

    tooltip.innerHTML = `
        Price: $${{Math.round(price).toLocaleString()}}<br>
        Block: ${{blockHeight.toLocaleString()}}<br>
        Time: ${{utcTime}}
    `;

    tooltip.style.left = (event.clientX + 5) + 'px';
    tooltip.style.top = (event.clientY + window.scrollY - 75) + 'px';
    tooltip.style.opacity = 1;
}} else {{
    tooltip.style.opacity = 0;
}}
}});




</script>


<script>
// Download canvas as PNG
const downloadBtn = document.getElementById('downloadBtn');
downloadBtn.addEventListener('click', function() {{
    const link = document.createElement('a');
    link.download = 'UTXOracle_Local_Node_Price.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
}});
</script>

<br>
<br>


<h2 style="margin-top:10px; font-size:24px;">
Want a 
<span style="color:orange; font-size:24px;">Live Updating Oracle</span>
  with New Mempool Transactions? 
</h2>


<iframe
    width="{width}"
    height="{height}"
    src="https://www.youtube.com/embed/live_stream?channel=UCXN7Xa_BF7dqLErzOmS-B7Q&autoplay=1&mute=1"
    frameborder="0"
    allow="autoplay; encrypted-media"
    allowfullscreen
    
</iframe>



<br>

</body>
</html>
